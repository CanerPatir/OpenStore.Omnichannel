@using System.Security.Claims
@using System.Net
@using OpenStore.Omnichannel.Panel.Resources

@inherits ComponentBase

@code {
        protected const string DontShowOnMobile = "d-none d-md-block";
        protected const string JustShowOnMobile = "d-block d-md-none";

    [Inject]
    protected IJSRuntime JsRuntime { get; init; }

    protected IJSInProcessRuntime JsRuntimeSync => (IJSInProcessRuntime) JsRuntime;
    
    [Inject]
    protected IStringLocalizer<App> SharedLocalizer { get; init; }
    
    [Inject]
    protected NavigationManager Navigation { get; init; }

    public void Alert(string message) => JsRuntimeSync.InvokeVoid("alert", message);

    public bool Confirm(string message) => JsRuntimeSync.Invoke<bool>("confirm", message);

    public bool ConsoleLog(string message) => JsRuntimeSync.Invoke<bool>("console.log", message);

    public bool ConsoleError(string message) => JsRuntimeSync.Invoke<bool>("console.error", message);

    [CascadingParameter]
    private Task<AuthenticationState> AuthenticationStateTask { get; set; }

    [Inject]
    protected IApiClient ApiClient { get; init; }

    [Inject]
    private SignOutSessionStateManager SignOutManager { get; init; }

    protected void ShowSuccess(string message, string title = null) => JsRuntimeSync.ShowSuccess(message, title);

    protected void ShowError(string message, string title = null) => JsRuntimeSync.ShowError(message, title);

    protected void ShowWarning(string message, string title = null) => JsRuntimeSync.ShowWarning(message, title);
    
    protected string Localize(string message, IEnumerable<string> arguments)
    {
        Alert(message);
        Alert(arguments.Count().ToString());
        return SharedLocalizer[message, arguments];
    }

    protected bool Loading { get; private set; }
    protected bool LoadedAny { get; private set; }
    
    protected async Task Run(Func<Task> operation, bool noAlert = false)
    {
        try
        {
            await operation();
        }
        catch (ApiException ex)
        {
            if (ex.IsUnauthorized && ex.IsInvalidToken)
            {
    // ReloadPage();
                BeginSignOut();
            }

            if (!noAlert)
            {
                HandleApiException(ex);
            }
        }
        catch (Exception ex)
        {
            if (!noAlert)
            {
                if (ex.Message.Contains("Failed to fetch"))
                {
                    ShowError("Sunucu ile iletişime geçilemiyor. Lütfen internet bağlantınızı kontrol edin.", "Bağlantı Hatası");
                }
                else
                {
                    ShowError(SharedLocalizer[ex.Message], "Hata");
                }
            }
        }
    }

    protected virtual void HandleApiException(ApiException ex)
    {
        if (ex.StatusCode == HttpStatusCode.NotFound)
        {
            ShowError("Kayıt bulunamadı", "Hata");
        }
        else if (ex.StatusCode == HttpStatusCode.BadRequest)
        {
            ShowError(SharedLocalizer[ex.GetMessageKey()], "Hata");
        }
        else if (ex.StatusCode == HttpStatusCode.Forbidden)
        {
            ShowError("Yetkisiz erişim", "Hata");
        }
        else
        {
            ConsoleError(ex.ToString());

            var message = ex.GetAggregatedErrorMessage();

            ShowError(SharedLocalizer[message], "Hata");
        }
    }

    protected async Task RunInLoading(Func<Task> operation, bool noAlert = false)
    {
        Loading = true;
        try
        {
            await Run(operation, noAlert);
        }
        finally
        {
            Loading = false;
            LoadedAny = true;
        }
    }

    protected async Task<T> GetWithLoading<T>(Func<Task<T>> operation, bool noAlert = false)
    {
        T result = default;
        await RunInLoading(async () => { result = await operation(); }, noAlert);
        return result;
    }

    protected async Task<bool> IsInRole(string role)
    {
        var user = await GetUser();
        if (user.IsRolesEmpty())
        {
    // ReloadPage();
            throw new Exception("Roles not found " + user.Identity.IsAuthenticated);
        }

        return user.InRole(role);
    }

    protected async Task<ClaimsPrincipal> GetUser() => AuthenticationStateTask == null ? null : (await AuthenticationStateTask)?.User;

    protected async Task<Guid> GetUserId() => (await GetUser()).GetId();

    protected async Task<bool> IsAuthenticated() => (await GetUser())?.Identity?.IsAuthenticated ?? false;

    protected async void BeginSignOut()
    {
        await SignOutManager.SetSignOutState();
        Navigation.NavigateTo("authentication/logout");
    }

    private void ReloadPage() => Navigation.Reload();

}