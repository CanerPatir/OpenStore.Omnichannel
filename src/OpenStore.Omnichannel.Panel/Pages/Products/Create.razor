@page "/products/add"
@using OpenStore.Omnichannel.Shared.Dto.Product
@using OpenStore.Omnichannel.Panel.Pages.Products.Media
@using OpenStore.Omnichannel.Panel.Pages.Products.Variant

@inject IStringLocalizer<Create> L

<Container>
    <Row class="justify-content-center">
        <Column ColumnSize="ColumnSize.Is8.OnDesktop">
            <OsPageTitle RootHref="products">
                <TitleSection>
                    @if (string.IsNullOrWhiteSpace(_product.Title))
                    {
                        <span>@L["NewProduct"]</span>
                    }
                    else
                    {
                        <span>@_product.Title</span>
                    }
                </TitleSection>
                <ButtonsSection>
                    <Button Loading="_saving" Clicked="Save" Color="Color.Success">
                        @if (!_saving)
                        {
                            <Icon Name="IconName.Save" Class="me-1"></Icon>
                        }
                        @L["Button.Save"]
                    </Button>
                </ButtonsSection>
            </OsPageTitle>

            <Validations @ref="_validations" Mode="ValidationMode.Manual" Model="_product">
                <Row>
                    <Column ColumnSize="ColumnSize.Is12">
                        <Alert Color="Color.Danger" Visible="@_formHasErrors">
                            <Heading Size="HeadingSize.Is6" TextColor="TextColor.Danger">
                                @L["Alert.ValidationErrors"]
                            </Heading>
                            <Blazorise.ValidationSummary Margin="Margin.Is0"/>
                        </Alert>
                    </Column>
                </Row>
                <Row>
                    <Column ColumnSize="ColumnSize.Is8.OnDesktop">
                        <ProductContentEditor @ref="_contentEditor" Model="@_product" ModelChanged="@(p => StateHasChanged())"/>
                        <MediaEditor Model="@_product"/>
                        <CreateVariantsEditor Model="@_product" ModelChanged="@(p => StateHasChanged())"/>
                        @if (!_product.HasMultipleVariants)
                        {
                            <PricingEditor Model="@_product.Variants.First()"/>
                            <InventoryEditor Model="@_product.Variants.First()"/>
                            <ShippingEditor Model="@_product"/>
                        }
                        <MetaEditor Model="@_product"/>
                    </Column>

                    <Column ColumnSize="ColumnSize.Is4.OnDesktop">
                        <ListGroup Margin="Margin.Is3.FromBottom">
                            <StatusEditor Model="@_product"/>
                        </ListGroup>
                        <ListGroup Margin="Margin.Is3.FromBottom">
                            <TagsEditor Model="@_product"/>
                        </ListGroup>
                    </Column>
                </Row>
            </Validations>
            <hr class="mb-4">
            <Row>
                <div class="d-flex align-items-center mb-4">
                    <div class="ms-auto">
                        <Button Loading="_saving" Clicked="Save" Color="Color.Success">
                            @if (!_saving)
                            {
                                <Icon Name="IconName.Save" Class="me-1"></Icon>
                            }
                            @L["Button.Save"]
                        </Button>
                    </div>
                </div>
            </Row>
        </Column>
    </Row>
</Container>


@code {
    private readonly ProductDto _product = new();
    private Validations _validations;
    private ProductContentEditor _contentEditor;

    private bool _saving;
    private bool _formHasErrors;

    private async Task Save()
    {
        _formHasErrors = !_validations.ValidateAll();
        if (_formHasErrors)
        {
            return;
        }

        try
        {
            _saving = true;
            _product.Description = await _contentEditor.GetDescriptionHtml();
            var productId = await ApiClient.Product.CreateProduct(_product);
    // ShowSuccess(L["Success.ProductCreated"]);
            Navigation.NavigateTo($"products/{productId}");
        }
        finally
        {
            _saving = false;
            await InvokeAsync(StateHasChanged);
        }
    }

}